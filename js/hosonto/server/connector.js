function BaseConnector(e){}function getConnector(e,o){Interface.ensureImplements(e,absConnector),this.myConnector=e}function createInjector(){function e(e,o){t[e]=o}function o(e,o){i[e]=o}function n(e,n){o(e,function(){var e=Object.create(n.prototype);return s(n,e),e})}function s(){var e,o,n,r=[];"string"==typeof arguments[0]?(e=arguments[1],o=arguments[0].replace(/ /g,"").split(","),n=arguments[2]||{}):(e=arguments[0],o=e.toString().match(/^function\s*[^\(]*\(\s*([^\)]*)\)/m)[1].replace(/ /g,"").split(","),n=arguments[1]||{});var r=o.map(function(e){if(t.hasOwnProperty(e))return t[e];if(i.hasOwnProperty(e)){var o=i[e],n=s(o);return t[e]=n,n}});return e.apply(n||{},r)}var t={},i={};return{value:e,factory:o,service:n,invoke:s}}var interface=require("./interface.js"),async=require("async"),abstractConnector=new interface.Interface("AbstractConnector",["connect","disconnect","create","update","delete","getNextSeq","find","loadAutoParams","saveAutoParams","loadAutoTable","getParameter","saveParameter","findAndUpdate"]);BaseConnector.prototype={loadAutoTable:function(e,o){var n=this,s="0",t=(e.length,[]);for(p in e){console.log("** "+p+" val "+e[p]);var i=p.split("___");if(i.length>1){var r={};i[1]&&""!=i[1]&&(r[i[1]]=e[p]),console.log("table::"+i[0]+"__SessionId::"+s+"params="+i[1]+"upd="+JSON.stringify(r)),function(o){t.push(new Promise(function(s,t){n.connector.find(i[0],r,!0,function(n,i){n?t(n):(console.log("err::"+n+" p::"+o+" val::"+i),e[o]=i,s(i))})}))}(p)}}Promise.all(t).then(function(n){o&&o(e.__SessionId)}).catch(function(e){console.log("promise error"+e)})},loadAutoParams:function(e,o){console.log("inside loadAutoParams:"),this.connector.find(this.connector,{__SessionId:e.__SessionId},function(n,s){if(n)console.log("loadAutoParams:error"+n);else{console.log("loadAutoParams:success"+JSON.stringify(s));for(var t=0,i=0;t<s.length;t++)console.log("Key:"+s[t].key+"Value:"+s[t].value),null==s[t].subKey||""==s[t].subKey||void 0==s[t].subKey?(e[s[t].key]=s[t].value,i=0):(e[s[t].key][s[t].subKey][i]=s[t].value,i++)}BaseConnector.prototype.loadAutoTable(e,o)})},saveAutoParams:function(e,o){var n=this,s="0";n.callback=o,n.connector.findSessionParam(n.connector,{__SessionId:e.__SessionId},function(o,t){s=t.__SessionId,o||""==t.__SessionId||void 0==t.__SessionId?(console.log("saveAutoParams::NULL"),n.connector.getNextSeq("__SessionId",function(o,t){s=t.seq,o||(console.log("saveAutoParams::NULL"+t.seq),e.__SessionId=t.seq,BaseConnector.prototype.saveParamsForValidSessionId(t.seq,e,n.callback))})):(console.log("saveAutoParams::"+t.__SessionId),e.__SessionId=t.__SessionId,BaseConnector.prototype.saveParamsForValidSessionId(t.__SessionId,e,n.callback))})},saveParamsForValidSessionId:function(e,o,n){var s,t=this;console.log("saveParamsForValidSessionId::"+e+" params::"+JSON.stringify(o)),o.__SessionId=e;var i=[],r=[],a=function(e,o,n){i.push(new Promise(function(s,i){console.log("Table="+n+" Query="+JSON.stringify(e)+" Update="+JSON.stringify(o)),n?t.connector.update(n,e,o,!0,function(e,o){e?i(e):s(o)}):t.connector.update(e,o,function(e,o){e?i(e):s(o)})}))};for(s in o)if(r=s.split("___"),r.length>1){console.log("table::"+r[0]+"Index="+s+"__SessionId::"+e+"params="+r[1]),console.log("param::no idx"+JSON.stringify(o[s][0]));var c={},l={};o[s]._id?c._id=o[s]._id:c._sessionId=e,l=o[s],function(e,o,n){a(e,o,n)}(c,l,r[0])}else console.log("** "+s+" val "+o[s]),function(e,o){a(e,o)}({__SessionId:e,key:s},{__SessionId:e,key:s,value:o[s]});Promise.all(i).then(function(e){console.log("saveParamsForValidSessionId promises success"+JSON.stringify(e)),n&&n(o.__SessionId)}).catch(function(e){console.log("saveParamsForValidSessionId promise error"+e+"::"+JSON.stringify(i[0])),n&&n(o.__SessionId)})},saveAutoTable:function(e,o){var n=this,s="0";n.callback=o,n.connector.findSessionParam(n.connector,{__SessionId:e.__SessionId},function(o,t){s=t.__SessionId,o||""==t.__SessionId||void 0==t.__SessionId?(console.log("saveAutoTable::NULL"),n.connector.getNextSeq("__SessionId",function(o,t){s=t.seq,o||(console.log("saveAutoTable::NULL"+t.seq),e.__SessionId=t.seq,BaseConnector.prototype.saveParamsForValidSessionId(t.seq,e,n.callback))})):(console.log("saveAutoTable::"+t.__SessionId),e.__SessionId=t.__SessionId,BaseConnector.prototype.saveParamsForValidSessionId(t.__SessionId,e,n.callback))})},getParameter:function(e,o,n,s){var t={__SessionId:e};null!==o&&""!==o&&(t.key=o),null!==n&&""!==n&&(t.subKey=n),console.log("getParameter:"+arguments[1]+":"+JSON.stringify(t)),this.connector.findSessionParam(this.connector,t,function(t,i){console.log("getParameter::0:"+o+":"+n+": "+e+":err "+t+":res "+JSON.stringify(i)),s(t,i)})},saveParameter:function(e,o,n,s,t){this.connector.update(this.connector,{__SessionId:e,key:o,subKey:n},{__SessionId:e,key:o,subKey:n,value:s},function(e,o){console.log("saveParameter:"+JSON.stringify(e)+"resp:"+JSON.stringify(o)),t()})}},MongoConnector=function(e,o){var n,s,t,i,r;n=s=t=i=r={a:"A"},this.mongoose=o,this.server=e,n=this.mongoose.Schema,s=new n({_id:String,seq:Number}),t=new n({__SessionId:{type:Number,index:1,required:!0},key:{type:String,required:!0},subKey:{type:String},rowId:{type:Number},value:{type:String}}),i=this.mongoose.model("counters",s),r=this.mongoose.model("sessionparameters",t),this.connector=this,MongoConnector.superclass.connector=this,this.mongoose.connection.on("error",function(o){console.error("Failed to connect to DB "+e+" on startup ",o)}),this.mongoose.connection.on("disconnected",function(){console.log("Mongoose default connection to DB :"+e+" disconnected")});var a=function(){var o=require("mongoose");o.connection.close(function(){console.log("Mongoose default connection with DB :"+e+" is disconnected through app termination"),process.exit(0)})};process.on("SIGINT",a).on("SIGTERM",a),interface.Interface.ensureImplements(this,abstractConnector),this.getSessionParameterTable=function(){return r},this.getCounters=function(){return i}},interface.extend(MongoConnector,BaseConnector),MongoConnector.prototype={connect:function(){console.log("Connecting to Server: "+this.server),this.mongoose.connect(this.server)},disconnect:function(){this.mongoose.disconnect()},create:function(e,o,n){var s=new e(o);s.save(n)},updateDefault:function(e,o,n,s){var t=e.getSessionParameterTable().update(o,n);t.setOptions({upsert:!0,multi:!0}),t.exec(s)},update:function(e,o,n,s,t){if(arguments.length<=3)MongoConnector.prototype.updateDefault(this,arguments[0],arguments[1],arguments[2]);else{var i=this.mongoose.model(e);if(console.log("connection:update:0:"+JSON.stringify(o)+"upd"+JSON.stringify(n)),s){var o=i.update(o,n);o.setOptions({upsert:!0,multi:!0}),o.exec(t)}else{var o=i.findOne(o);o.setOptions({upsert:!0}),o.exec(function(e,s){if(e)throw e;o=s.update(n),o.exec(t)})}}},findAndUpdate:function(e,o,n,s,t){var i=this.mongoose.model(e);if(console.log("connection:update:0:"+JSON.stringify(o)+"upd"+JSON.stringify(n)),s){var o=i.findOneAndUpdate(o,n,{new:!0,upsert:!0,multi:!0});o.exec(t)}else{var o=i.findOneAndUpdate(o,n,{new:!0,upsert:!0});o.exec(t)}},delete:function(e,o,n,s){var t=this.mongoose.model(e);if(n){var o=t.remove(o);o.exec(s)}else{var o=t.findOne(o);o.exec(function(e,n){if(e)throw e;o=n.remove(s)})}},findSessionParam:function(e,o,n){console.log("findSessionparam: "+JSON.stringify(o)),e.getSessionParameterTable().find(o,n)},findDefault:function(e,o,n){e.getSessionParameterTable().find(o,n)},find:function(e,o,n,s){if(arguments.length<=3)return void MongoConnector.prototype.findDefault(arguments[0],arguments[1],arguments[2]);var t=this.mongoose.model(e);n?(console.log("inside query::"+JSON.stringify(o)),t.find(o,s)):t.findOne(o,s)},getNextSeq:function(e,o){this.getCounters().findOneAndUpdate({_id:e},{$inc:{seq:1}},{upsert:!0,new:!0},o)},loadAutoParams:function(){MongoConnector.superclass.loadAutoParams.apply(this,arguments)},saveAutoParams:function(){MongoConnector.superclass.saveAutoParams.apply(this,arguments)},loadAutoTable:function(){MongoConnector.superclass.loadAutoTable.apply(this,arguments)},saveAutoTable:function(){MongoConnector.superclass.saveAutoTable.apply(this,arguments)},getParameter:function(){MongoConnector.superclass.getParameter.apply(this,arguments)},saveParameter:function(){MongoConnector.superclass.saveParameter.apply(this,arguments)}},exports.MongoDBConnector=MongoConnector;