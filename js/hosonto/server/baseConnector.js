function BaseConnector(o){}var interface=require("./interface.js"),async=require("async");BaseConnector.prototype={loadAutoTable:function(o,e){var n=this,s="0",a=(o.length,[]);for(p in o){var i=p.split(new RegExp("_TABLE"));if(console.log("**LOAD "+p+" val "+o[p]+" arr="+JSON.stringify(i)+" len="+i.length),i.length>1&&!i[1]){var r={};o[i[0]+"_FIELD_"]&&""!=o[i[0]+"_FIELD_"]&&(r="object"==typeof o[i[0]+"_FIELD_"]?o[i[0]+"_FIELD_"]:JSON.parse(o[i[0]+"_FIELD_"])),console.log("Load table::"+i[0]+"__SessionId::"+s+"arr1="+i[1]+"qry="+JSON.stringify(r)),function(e){a.push(new Promise(function(s,a){var t=o[i[0]+"__appendPage"];n.connector.find(i[0],r,!0,function(n,i){n?(console.log("\n\n\n *** ERROR occurred in promise::"+n),a(n)):(console.log("err::"+n+" p::"+e+" val::"+i),t&&0!=t?(o[e]||(o[e]=[]),"string"==typeof i?o[e]=o[e].concat(i.replace(/^\"+|\"+$/gm,"")):Array.isArray(o[e])?o[e]=o[e].concat(i):o[e]=i):"string"==typeof i?o[e]=i.replace(/^\"+|\"+$/gm,""):o[e]=i,s(i))},o)}))}(p)}}Promise.all(a).then(function(n){e&&e(o.__SessionId)}).catch(function(o){console.log("\n\n\n ***promise error"+o)})},loadAutoParams:function(o,e){console.log("inside loadAutoParams:params="+JSON.stringify(o)),this.connector.findDefault(this.connector,{__SessionId:o.__SessionId},function(n,s){if(n)console.log("loadAutoParams:error"+n);else{console.log("   loadAutoParams:SUCCESS  "+s);for(var a=0,i=0;a<s.length;a++)console.log("Key:"+s[a].key+"Value:"+s[a].value),null==s[a].subKey||""==s[a].subKey||void 0==s[a].subKey?("string"==typeof s[a].value?o[s[a].key]=s[a].value.replace(/^\"+|\"+$/gm,""):o[s[a].key]=s[a].value,i=0):(i++,"string"==typeof s[a].value?o[s[a].key][s[a].subKey][i]=s[a].value.replace(/^\"+|\"+$/gm,""):o[s[a].key][s[a].subKey][i]=s[a].value)}BaseConnector.prototype.loadAutoTable(o,e)})},saveAutoParams:function(o,e){var n=this,s="0";n.callback=e,n.connector.findSessionParam(n.connector,{__SessionId:o.__SessionId},function(e,a){s=a.__SessionId,e||""==a.__SessionId||void 0==a.__SessionId?(console.log("saveAutoParams::NULL"),n.connector.getNextSeq("__SessionId",function(e,a){s=a.seq,e||(console.log("saveAutoParams::NULL"+a.seq),o.__SessionId=a.seq,BaseConnector.prototype.saveParamsForValidSessionId(a.seq,o,n.callback))})):(console.log("saveAutoParams::"+a.__SessionId),o.__SessionId=a.__SessionId,BaseConnector.prototype.saveParamsForValidSessionId(a.__SessionId,o,n.callback))})},saveParamsForValidSessionId:function(o,e,n){var s,a,i=this;console.log("saveParamsForValidSessionId::"+o+" params::"+JSON.stringify(e)),e.__SessionId=o;var r=[],t=function(o,e,n){r.push(new Promise(function(s,a){console.log("\n\n\n\nTable="+n+" Query="+JSON.stringify(o)+" Update="+JSON.stringify(e)),n?e.isDeleted?i.connector.delete(n,o,!0,function(o,e){o?a(o):s(e)}):i.connector.update(n,o,e,!0,function(o,e){o?a(o):s(e)}):i.connector.update(o,e,function(o,e){o?a(o):s(e)})}))};for(s in e){var l=s.split("_TABLE");if(console.log("@@ SAVEPARAMS"+s+" val "+e[s]+" Arr="+JSON.stringify(l)+" length="+l.length),l.length>1&&!l[1])if(console.log("Save table::"+l[0]+"__SessionId::"+o+"params="+l[1]),"object"==typeof e[s]){console.log("param::array ="+JSON.stringify(e[s]));for(a in e[s]){console.log("param::idx"+a+" ="+JSON.stringify(e[s][a]));var c={},_={};e[s][a]._id&&(c._id=e[s][a]._id),_=JSON.parse(JSON.stringify(e[s][a])),c._id||(c._sessionId=o+":"+(100*Math.random()+1)),function(o,e,n){t(o,e,n)}(c,_,l[0])}}else{console.log("param::no idx"+JSON.stringify(e[s][0]));var c={},_={};e[s]._id?c._id=e[s]._id:c._sessionId=o,function(o,e,n){t(o,e,n)}(c,_,l[0])}else console.log("** SAVE "+s+" val "+e[s]),function(o,e){t(o,e)}({__SessionId:o,key:s},{__SessionId:o,key:s,value:JSON.stringify(e[s])})}Promise.all(r).then(function(o){console.log("saveParamsForValidSessionId promises success"+JSON.stringify(o)),n&&n(e.__SessionId)}).catch(function(o){console.log("saveParamsForValidSessionId promise error"+o+"::"+JSON.stringify(r[0])),n&&n(e.__SessionId)})},saveAutoTable:function(o,e){var n=this,s="0";n.callback=e,n.connector.findSessionParam(n.connector,{__SessionId:o.__SessionId},function(e,a){s=a.__SessionId,e||""==a.__SessionId||void 0==a.__SessionId?(console.log("saveAutoTable::NULL"),n.connector.getNextSeq("__SessionId",function(e,a){s=a.seq,e||(console.log("saveAutoTable::NULL"+a.seq),o.__SessionId=a.seq,BaseConnector.prototype.saveParamsForValidSessionId(a.seq,o,n.callback))})):(console.log("saveAutoTable::"+a.__SessionId),o.__SessionId=a.__SessionId,BaseConnector.prototype.saveParamsForValidSessionId(a.__SessionId,o,n.callback))})},getParameter:function(o,e,n,s){var a={__SessionId:o};null!==e&&""!==e&&(a.key=e),null!==n&&""!==n&&(a.subKey=n),console.log("getParameter:"+arguments[1]+":"+JSON.stringify(a)),this.connector.findSessionParam(this.connector,a,function(a,i){console.log("getParameter::0:"+e+":"+n+": "+o+":err "+a+":res "+JSON.stringify(i)),s(a,i)})},saveParameter:function(o,e,n,s,a){this.connector.update(this.connector,{__SessionId:o,key:e,subKey:n},{__SessionId:o,key:e,subKey:n,value:s},function(o,e){console.log("saveParameter:"+JSON.stringify(o)+"resp:"+JSON.stringify(e)),a()})}},exports.BaseConnector=BaseConnector;